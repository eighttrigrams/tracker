{:docs-dir "build-next-feature"

 :documents
 {:next-feature                    {:file "NEXT_FEATURE.md"}
  :exploratory-implementers-complaints           {:file "EXPLORATORY_IMPLEMENTERS_COMPLAINTS.md"}
  :exploratory-justification       {:file "EXPLORATORY_IMPLEMENTATION_DECISIONS_JUSTIFICATION.md"}
  :pr-architecture-review          {:file "PR_ARCHITECTURE_REVIEW_RESULT.md"}
  :pr-data-consistency-review      {:file "PR_DATA_CONSISTENCY_REVIEW_RESULT.md"}
  :pr-security-review              {:file "PR_SECURITY_REVIEW_RESULT.md"}
  :boyscout-observations           {:file "BOYSCOUT_OBSERVATIONS.md"}
  :boyscout-plan                   {:file "BOYSCOUT_PLAN.md"}
  :implementation-plan             {:file "IMPLEMENTATION_PLAN.md"}
  :human-opinion                   {:file "HUMAN_OPINION.md" :allow-single-line? true}
  :boyscout-report                 {:file "BOYSCOUT_REPORT.md"}
  :feature-justification           {:file "FEATURE_IMPLEMENTATION_DECISIONS_JUSTIFICATION.md"}
  :commit-message-body             {:file "COMMIT_MESSAGE_BODY.txt"}}

 :stages
 [{:id :exploratory-implementation
   :requires [:next-feature]
   :produces [:exploratory-implementers-complaints :exploratory-justification]
   :run-tests? true
   :commit {:message "Exploratory implementation"}
   :prompt "We are building a new feature {{feature-name}}.

1. Implement the feature.
  - if it touches the user interface (which is almost always the case)
    - use a skill
    - take screenshots for proof of important key aspects
2. Make sure you get the unit tests running (`clj -X:test`)
3. Now that you have an implementation which matches the specification of the new feature handed to you, consider the following: What things did you encounter which caused
  you extra work which wouldnt otherwise have occurred where the code structured in a cleaner way?
  - Write the cleaner ways down in {{exploratory-implementers-complaints}}
    - Make sure absolutely nothing specifically pertaining to the new feature goes here. For the purpose of that report, we care about the state of the codebase we found, pretending we dont know what we build next. You only report what you thought made things difficult, and you run in unnecessary loops and through unnecessary hoops, which you wouldnt have to, if things were nice and tidy.
4. Explain how what you have done matches what was asked of you.
    - Write this to {{exploratory-justification}}
        - If you have taken screenshots, list names of screenshots in this doc (prefix the names with where they are stored, namely .playwright-mcp/)"}

  {:id :code-review
   :requires [:exploratory-implementers-complaints :exploratory-justification]
   :produces [:pr-architecture-review :pr-data-consistency-review :pr-security-review]
   :prompt "Start three code reviewer subagents, to look at the current diff against master.

1. Does an architecture review; results go to {{pr-architecture-review}}
2. Does an data consistency review; results go to {{pr-data-consistency-review}}
3. Does an security review; results go to {{pr-security-review}}"}

  {:id :code-smell-detection
   :produces [:boyscout-observations]
   :prompt "Look at the diff between HEAD and master (`git diff master...HEAD`).

For each changed file, also look at surrounding context (the full functions/namespaces that were touched).

Identify code smells such as:
- Long functions (more than ~20 lines)
- Long require/import lists
- Deeply nested code
- Duplicated code patterns
- Poor naming
- Missing abstractions

Focus ONLY on the areas touched by the diff, not the entire codebase.
Do NOT include anything specific to the new feature - only pre-existing smells that were exposed.

Write your findings to {{boyscout-observations}}."}

  {:id :planning
   :requires [:exploratory-implementers-complaints
              :next-feature
              :exploratory-justification
              :pr-architecture-review
              :pr-security-review
              :pr-data-consistency-review
              :boyscout-observations]
   :produces [:boyscout-plan :implementation-plan]
   :prompt "Then look at the previous to last commit (against master). Its name is \"feature/{{feature-name}} - Exploratory implementation\"

## High level - what we gonna do

From the reviews, and all what you know NOW, write
- {{boyscout-plan}}
- {{implementation-plan}}.

We will execute the new implementation in two phases,
1. the cleanup phase done by a boyscout,
2. and then the proper implementation.

## Info on the plan files to write

We dont want to repeat things, so any item goes either to the boyscout plan
or to to the implementation plan but not to both.

### Boyscout plan
            
Take especially seriously what you learned from {{exploratory-implementers-complaints}} and {{boyscout-observations}}.

Note that soon we will revert the last commit in which we did our exploration.
So the cleanup will be performed against the sources as they appeared in main branch.
Dont put anything specific to our feature in the preparatory boyscout plan. Just make it
nicer for the things which go to the proper implementation. I repeat: Absolutely **nothing
pertaining to the feature** we are about to build goes into {{boyscout-plan}}.

### Implementation plan

For the proper implementation, then
- Pick mostly high and medium issues from the todos.
- Be specific which files the implementer should touch on this next, better attempt"}

  {:id :human-review
   :requires [:boyscout-plan :implementation-plan]
   :produces [:human-opinion]
   :human-input? true
   :start-app? true
   :message "Please human, add your verdict in {{human-opinion}} (note that the app is up at 3027)"}

  {:id :revert
   :cleanup [:exploratory-implementers-complaints :exploratory-justification
             :pr-architecture-review :pr-data-consistency-review :pr-security-review]
   :git-revert? true}

  {:id :boyscout-refactoring
   :requires [:boyscout-plan :human-opinion]
   :produces [:boyscout-report]
   :run-tests? true
   :commit {:message "Preparatory refactoring"}
   :cleanup-after [:boyscout-plan]
   :prompt "Now implement the boyscout plan!

Make sure tests run (`clj -X:test`)

Report what you did in {{boyscout-report}}"}

  {:id :implementation
   :requires [:next-feature :boyscout-report :implementation-plan :human-opinion]
   :produces [:feature-justification]
   :run-tests? true
   :cleanup-after [:boyscout-report :implementation-plan :human-opinion]
   :prompt "Now implement the feature properly, according to the implementation plan!
Make sure to use the UI skill to watch your implementation results live in the browser.

Make sure tests run (`clj -X:test`)

Report what you did in {{feature-justification}}"}

  {:id :final-review
   :requires [:feature-justification]
   :human-input? true
   :start-app? true
   :message "Human, please visit the app in a browser, and also check the changes. Everything ok?"}

  {:id :commit-implementation
   :commit {:message "Implementation"}
   :stop-app? true}

  {:id :synthesize-commit
   :requires [:next-feature :feature-justification]
   :produces [:commit-message-body]
   :prompt "Write a commit message body summarizing what was done and why.
Output ONLY the commit message body (no subject line, no markdown fences).
Write the result to {{commit-message-body}}"}

  {:id :finalize
   :amend-commit? true
   :cleanup-after [:commit-message-body :feature-justification]
   :clear-next-feature? true}]}
